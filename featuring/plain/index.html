<html>

<head>
  <style>
    @import url(http://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.1/css/selectize.min.css);
    #input-tags {
      width: 100%;
    }
  </style>
  <script src="jquery.js"></script>
  <script src="jquery-ui.min.js"></script>
  <script src="selectize.js"></script>
</head>

<body>

  <section class="skills">
    <div class="self">
      <!-- for pull-down menu with completion -->
      <input type="text" id="input-proxy" />
      <!-- for tags with delete cross -->
      <input type="text" id="input-tags" />
    </div>
  </section>

  <script>
    /** callback for calling the web service (dbpedia lookup)
     * arguments: query: the (partial) keyword for dbpedia
     * callback: inner selectize function  */
    var loadFunction = function(query, callback) {
      console.log("query:" + query);
      $.ajax({
        type: "GET",
        dataType: "json",
        url: "http://lookup.dbpedia.org/api/search.asmx/KeywordSearch",
        data: {
          QueryString: query
        },
        beforeSend: function(xhr) {
          xhr.setRequestHeader("Accept", "application/json");
        },
        error: function() {
          callback();
        },
        success: function(res) {
          var json = res.results;
          for (var entry in json) {
            // hack to filter options displayed on dropdown; see searchField below
            json[entry]["query"] = query;
            console.log(json[entry]);
          }
          callback(res.results);
        }
      });
    };

    // TODO handle selection from arrow keys
    // TODO use score function to avoid partial matching ?

    // DEBUG:
    var onInitializeFunction = function(data) {
      console.log("selectize.js is initialized");
    };

    // selectize options
    var options = {
      onInitialize: onInitializeFunction,
      plugins: ["remove_button" /*, "drag_drop"*/],
      delimiter: ",",
      create: true,
      highlight: false,
      persist: false,
      valueField: "uri",
      labelField: "label",
      searchField: "query",
      load: loadFunction,
      render: {
        option_create: function(data, escape) {
          return "";
        },
        option: function(data, escape) {
          return "<div>" + data.label + "</div>";
        }
      },
    }

    /** tell selectize to do its job on this HTML element */
    var select = $("#input-tags");
    // DEBUG : var tmp = (select.selectize(options)[0]); console.log(tmp);
    var selectize = (select.selectize(options)[0]).selectize;
    selectize.on("load", function(data) {
      console.log("loaded");
      for (var option in data) {
        console.log(data[option]);
        selectize.addOption({
          uri: data[option].uri,
          label: data[option].label
        });
      }
      selectize.refreshOptions(true);
    });

    /** wait some delay to send the characters typed */
    var delayFunction = function() {
      console.warn("items : " + this.items);
      this.setTextboxValue($("#input-proxy").val());
      console.log("will query : " + $("#input-proxy").val());
      var fn = this.settings.load;
      // TODO do nothing on empty string
      this.load(function(callback) {
        fn.apply(self, [$("#input-proxy").val(), callback]);
      });
      this.refreshOptions(true);
    }.bind(selectize);

    var timer = timer || 0;
    $("#input-proxy").keydown(function(e) {
      clearInterval(timer);
    });
    $("#input-proxy").keyup(function(e) {
      timer = window.setTimeout(delayFunction, 333);
    });
    // TODO Ã  revoir
    $("#input-proxy").on("blur", function() {
      this.focus();
    })
    $("#input-proxy").focus();
  </script>

</body>

</html>
